---
title: "Numerical simulation of dynamic systems with R: an introduction"
author: "Thomas Petzoldt and Karline Soetaert"
date: "`r Sys.Date()`"
bibliography: bib.bib
lang: en
output:
  xaringan::moon_reader:
    css: ["default", "useR-fonts", "tp_xaringan.css"]
    seal: false
    lib_dir: libs
    nature:
      beforeInit: "tp_xaringan.js"
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      self_contained: true
---


---

class: center, middle, title-slide

background-image: url("img/water-light.jpg")

# Numerical simulation of dynamic systems with R: an introduction

## Thomas Petzoldt and Karline Soetaert

### `r Sys.Date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library("dplyr")
library("tidyr")
library("kableExtra")
library("deSolve")
library("rootSolve")
mypar <- list(las=1, cex.lab=1.4, cex.axis=1.4, lwd=2)
```

<!-- citations work differently with xaringan compared to @Markdown / -->
```{r, load_refs, include=FALSE, cache=FALSE}
library("RefManageR")
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "authoryear",
           style = "markdown",
           dashed = FALSE)
bib <- ReadBib("./bib.bib", check = FALSE)
```

---


## Preface



Dynamical systems are found everywhere, in mathematics, physics, chemistry, engineering and business - ecology and aquatic sciences are no exception.

One common approach to describe such systems is by means of differential equations. Following the ideas of Forrester, differential equations appear quite naturally if we describe changes in a system in terms of growth and decay, which together make up a mass balance. A somewhat bigger challenge is to solve these differential equations - some of us may still remember the challenges of differential calculus in high school courses.

Fortunately, computer algorithms allow to solve even complex differential equation systems numerically. This has opened a world of practical applications to be accessible for anyone that has a basic knowledge in scientific computing, or is willing to acquire this knowledge. R is such a scientific computing language that offers powerful methods to solve differential equations. Moreover, some R-packages are especially designed to also solve spatially variable problems that are often found of importance in aquatic sciences.

The introduction will demonstrate selected examples: growth of organisms, predator-prey interaction, spread of diseases, and transport-reaction problems. The formulation of such models in R can be surprisingly compact and close to the mathematical equations. 

---

class: scrollable-slide

## Dynamical System


* In mathematics, a system in which a function describes the time dependence of a point in a geometrical space.
* Examples include models that describe the swinging of a clock pendulum, the flow of water in a pipe, and the number of fish each springtime in a lake.
* The state of a dynamical system at a given time is a vector of real numbers, a point in state space. 
* The evolution rule is a function that describes what future states follow from the current state.<sup>[1]</sup>


### Different ways of description

* statistical approach: time series of state variables (pools)
* dynamic approach: description of changes
    * automata in discrete time: IBMs, ABMs, cellular automata
    * equations in discrete time: difference equations
    * equations in continuous time: differential equations (ODEs)

A dynamical system can be described deterministically or stochastically. 

We focus on the **deterministic** description in **continuous** time
with numerically solved differential equations.

[1] Wikipedia, [Dynamical_system](https://en.wikipedia.org/wiki/Dynamical_system)
---

class: scrollable-slide

## Differential Calculus

.pull-left[

$\dot{y} = k \cdot y$

![:scale 50%](img/newton.jpg)

Isaac Newton, 1643 - 1727
]

.pull-right[

$\frac{dy}{dx} = k \cdot y$

![:scale 55%](img/leibniz.jpg)

Gottfried Wilhelm Leibniz, 1646 - 1716


]

---

## Forrester: System Dynamics

* differential equations are easy to understand, if we think in pools and changes


---

## Immigration and Exponential Growth


* simple figure that compares zero and first order growth
* first order growth involves feedback

---

## Analytical Integration and the Euler Method


* analytical integration
* stepwise solution with R = Euler's method
* problem of the explicit forward method: integration error

---

## Numerical Integration with deSolve: the naive way

* package **deSolve** `r Citep(bib, "deSolve_jss")` provides all necessary tools and supports
a consistent workflow:

* define the model as a function
* use ode
* use plot

---

## Runge-Kutta, ODEPACK, deSolve, part I


* approaches to resolve the integration error
* additional time steps and use of polynomials: RK-Methods
    * more precise, but precision depends on pre-defined time step
    * problem: either not precise enough or too much work
    * danger of instability
    * optimum time step can vary over time
    * stiff systems: some states change faster than others
* adaptive step size, guaranteed precision
    * different ways to appraoch this
    * combination of two RK methods
    * iteration methods, e.g. Adams or BDF
    * lsoda: switches between Adams (for stiff) and BDF (for non-stiff) regions
    

---

## Resource Limited Growth


* algae and phosphorus
* stoichiometry, package marelac
* functional response

---

## SIR and the Covid 19 Pandemic


* similar to resource-limited growth
* show atol, rtol and rescaling of problems

---

## External Interventions


* implementation of forcings
* plotting of scenarios

---

## Back to Lake Modelling: The Chemostat


* inflow and outflow
* numerical solution
* equilibrium
* rootSolve and analytical solution of equlibrium

---

## The Chemostat Code

.scrollable[
```{r echo=TRUE}
library("deSolve")
library("rootSolve")

chemostat <- function(time, init, parms) {
  with(as.list(c(init, parms)), {
    mu   <- mumax * P/(kp + P)  # Monod equation
    dAlg <- mu * Alg - D * Alg
    dP   <-  D *(P0 - P) - 1/Y * mu * Alg
    list(c(dAlg, dP), mu=mu)
   })
}
parms <- c(
  mumax = 0.5,    # 1/d
  kp    = 0.01,   # half saturation constant (mg/L)
  Y     = 41,     # yield coefficient (stoichiometric C:P ratio)
  D     = 0.1,    # 1/d
  P0    = 0.05    # P in inflow (mg/L)
)
times <- seq(0, 40, 0.1)  # (d)
init  <- c(Alg=0.01, P=0.05) # Phytoplankton C and Phosphorus P (mg/L)

## =============================================================================
## Dynamic simulation
## =============================================================================
out <- ode(init, times, chemostat, parms)
plot(out)

## =============================================================================
## Steady state solution
## =============================================================================
state <- data.frame(
  D = seq(0, 0.6, length.out = 100),
  X = 0,
  S = 0
)

for (i in 1:nrow(state)) {
  parms["D"] <- state$D[i]
  times <- c(0, Inf)
  out <- runsteady(init, times, chemostat, parms)
  state[i, 2:3] <- out$y
}

par(mfrow = c(3, 1))
plot(S ~ D, data = state, type = "l")
plot(X ~ D, data = state, type = "l")
plot(S * X ~ D, data = state, type = "l")
```
]

---

## Interaction Between Populations: Lotka-Volterra's Predator and Prey


* state diagram, cycles
* damped cycle if we introduce a Monod term

---

## Efficient Model Formulation in Matrix Style


* multi-species predator-prey model

---

## PDE's in 1D: Transport in a River


* package ReacTran
* uses also matrix formulation
* plot3D example

---

## Outlook


* some bigger applications
* rodeo package
* shiny

---

## Appendices


Things that should be mentioned somewhere, but not yet in the introductory
lecture

* Solver functions in deSolve
* C and Fortran interface
* Karline's books
* Online resources: R-Forge, CRAN-Taskview, publications



---

## Copyright


This resource was created by [tpetzoldt](github.com/tpetzoldt) and 
[karlines](https://github.com/karlines). It is provided 
as is without warranty.

---

## Bibliography

.scrollable[
```{r refs, echo=FALSE, results="asis"}
PrintBibliography(bib)
```
]
