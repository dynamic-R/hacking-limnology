<!DOCTYPE html>
<html lang="en" xml:lang="en">
  <head>
    <title>Numerical simulation of dynamic systems with R: an introduction</title>
    <meta charset="utf-8" />
    <meta name="author" content="Thomas Petzoldt and Karline Soetaert" />
    <meta name="date" content="2021-05-29" />
    <script src="libs/header-attrs-2.8.4/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/useR-fonts.css" rel="stylesheet" />
    <script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
    <script src="libs/viz-1.8.2/viz.js"></script>
    <link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
    <script src="libs/grViz-binding-1.0.6.1/grViz.js"></script>
    <link rel="stylesheet" href="tp_xaringan.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">


class: center, middle, title-slide

background-image: url("img/water-light.jpg")

&lt;!-- Own title slide / --&gt;

# Numerical simulation of dynamic systems with R: an introduction

## Thomas Petzoldt and Karline Soetaert


### IMPORTANT NOTE

This slide set is work in progress and corrently at a very early stage of development.

For the time being, please consult https://desolve-r-forge.r-project.org

### 2021-05-29



&lt;!-- citations work differently with xaringan compared to @Markdown / --&gt;


---


## Preface



Dynamical systems are found everywhere, in mathematics, physics, chemistry, engineering and business - ecology and aquatic sciences are no exception.

One common approach to describe such systems is by means of differential equations. Following the ideas of Forrester, differential equations appear quite naturally if we describe changes in a system in terms of growth and decay, which together make up a mass balance. A somewhat bigger challenge is to solve these differential equations - some of us may still remember the challenges of differential calculus in high school courses.

Fortunately, computer algorithms allow to solve even complex differential equation systems numerically. This has opened a world of practical applications to be accessible for anyone that has a basic knowledge in scientific computing, or is willing to acquire this knowledge. R is such a scientific computing language that offers powerful methods to solve differential equations. Moreover, some R-packages are especially designed to also solve spatially variable problems that are often found of importance in aquatic sciences.

The introduction will demonstrate selected examples: growth of organisms, predator-prey interaction, spread of diseases, and transport-reaction problems. The formulation of such models in R can be surprisingly compact and close to the mathematical equations. 

---

class: scrollable-slide

## Dynamical System


* In mathematics, a system in which a function describes the time dependence of a point in a geometrical space.
* Examples include models that describe the swinging of a clock pendulum, the flow of water in a pipe, and the number of fish each springtime in a lake.
* The state of a dynamical system at a given time is a vector of real numbers, a point in state space. 
* The evolution rule is a function that describes what future states follow from the current state.&lt;sup&gt;[1]&lt;/sup&gt;


### Different ways of description

* statistical approach: time series of state variables (pools)
* dynamic approach: description of changes
    * automata in discrete time: IBMs, ABMs, cellular automata
    * equations in discrete time: difference equations
    * equations in continuous time: differential equations (ODEs)

A dynamical system can be described deterministically or stochastically. 

We focus on the **deterministic** description in **continuous** time
with numerically solved differential equations.

[1] Wikipedia, [Dynamical_system](https://en.wikipedia.org/wiki/Dynamical_system)
---

class: scrollable-slide

## Differential Calculus

.pull-left[

`\(\dot{y} = k \cdot y\)`

![:scale 50%](img/newton.jpg)

Isaac Newton, 1643 - 1727
]

.pull-right[

`\(\frac{dy}{dx} = k \cdot y\)`

![:scale 55%](img/leibniz.jpg)

Gottfried Wilhelm Leibniz, 1646 - 1716


]

---

## Jay W. Forrester: System Dynamics


.pull-left[


![:scale 70%](img/forrester-fig3.png)
]



.pull-right[


![:scale 50%](img/forrester-fig4.png)
]

* thinking in feedback loops
* easy to understand, if we think in pools and changes

From: [Forrester, J.W. (2009) Some Basic Concepts in System Dynamics](https://www.cc.gatech.edu/classes/AY2018/cs8803cc_spring/research_papers/Forrester-SystemDynamics.pdf)

---

## Dynamic systems: how and why?


"Many believe that system dynamics has helped them become skilled at
inventing the future, either by sketching out causal loops on the back of
an envelope, or by assembling equations of cause and effect in a
computer model. Both approaches work." (J.W.F, 1995)


.pull-left[
#### Letâ€™s speak about computers
- continous time `\(\rightarrow\)` differential equations
- discrete time: another interesting story ...

.center[
![:scale 40%](img/rlogo.png)
]
]    

.pull-right[
#### Why numerical integration?
* Not all systems have an analytical solution.
* Numerical solutions allow discrete input.    

"... students can deal with high-order dynamic systems
without ever discovering that their elders consider such to be very difficult."
J.W. Forrester 2009.
]


---

## Import and Export

`$${
\frac{dX}{dt} = \mbox{import} - \mbox{export}\\
}$$`

<div id="htmlwidget-a3cb47ed4d2a1dcc34c8" style="width:864px;height:288px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-a3cb47ed4d2a1dcc34c8">{"x":{"diagram":"digraph feedback {\n         graph [rankdir = \"LR\"]\n           node [shape = box, penwidth=2, fontname = \"Helvetica\"]\n             Matter\n           node [shape = octagon, penwidth=0.5, style=\"rounded\", fixedsize=25, fontsize=8]\n             Source Sink\n           node [shape = none, fontsize=10]\n             import export\n           edge [penwidth=1.5]\n             Source -> import -> Matter -> export -> Sink\n         \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>



---

## Exponential Growth

`$${\frac{dN}{dt} = \mbox{birth} - \mbox{death}\\
\frac{dN}{dt} = \mbox{birthhrate} \cdot N - \mbox{deathrate}\cdot N\\
\frac{dN}{dt} = b \cdot N - d \cdot N = (b-d) \cdot N = r \cdot N\\
}$$`
<div id="htmlwidget-f905b136b6bbac59d4dc" style="width:864px;height:288px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-f905b136b6bbac59d4dc">{"x":{"diagram":"digraph feedback {\n         graph [rankdir = \"LR\"]\n           node [shape = box, penwidth=2, fontname = \"Helvetica\"]\n             Population\n           node [shape = octagon, penwidth=0.5, style=\"rounded\", fixedsize=25, fontsize=8]\n             Source Sink\n           node [shape = none, fontsize=10]\n             birth death\n           edge [penwidth=1.5]\n             Source -> birth -> Population -> death -> Sink\n           edge [penwidth=0.7, tailport = \"n\", headport = \"n\", constraint = false, color=tomato]\n             Population -> birth \n             Population -> death\n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>


---

## Analytical Integration and the Euler Method


* analytical integration
* stepwise solution with R = Euler's method
* problem of the explicit forward method: integration error

---

## Numerical Integration with deSolve: the naive way

* package **deSolve** ([Soetaert, Petzoldt, and Setzer, 2010b](http://www.jstatsoft.org/v33/i09)) provides all necessary tools and supports
a consistent workflow:

* define the model as a function
* use ode
* use plot

---

## Runge-Kutta, ODEPACK, deSolve, part I


* approaches to resolve the integration error
* additional time steps and use of polynomials: RK-Methods
    * more precise, but precision depends on pre-defined time step
    * problem: either not precise enough or too much work
    * danger of instability
    * optimum time step can vary over time
    * stiff systems: some states change faster than others
* adaptive step size, guaranteed precision
    * different ways to appraoch this
    * combination of two RK methods
    * iteration methods, e.g. Adams or BDF
    * lsoda: switches between Adams (for stiff) and BDF (for non-stiff) regions
    

---

## Resource Limited Growth


* algae and phosphorus
* stoichiometry, package marelac
* functional response

---

## SIR and the Covid 19 Pandemic


* similar to resource-limited growth
* show atol, rtol and rescaling of problems

---

## External Interventions


* implementation of forcings
* plotting of scenarios

---

## Back to Lake Modelling: The Chemostat


* inflow and outflow
* numerical solution
* equilibrium
* rootSolve and analytical solution of equlibrium

---

## The Chemostat Code

.scrollable[


```r
library("deSolve")
library("rootSolve")

chemostat &lt;- function(time, init, parms) {
  with(as.list(c(init, parms)), {
    mu   &lt;- mumax * P/(kp + P)  # Monod equation
    dAlg &lt;- mu * Alg - D * Alg
    dP   &lt;-  D *(P0 - P) - 1/Y * mu * Alg
    list(c(dAlg, dP), mu=mu)
   })
}
parms &lt;- c(
  mumax = 0.5,    # 1/d
  kp    = 0.01,   # half saturation constant (mg/L)
  Y     = 41,     # yield coefficient (stoichiometric C:P ratio)
  D     = 0.1,    # 1/d
  P0    = 0.05    # P in inflow (mg/L)
)
times &lt;- seq(0, 40, 0.1)  # (d)
init  &lt;- c(Alg=0.01, P=0.05) # Phytoplankton C and Phosphorus P (mg/L)

## =============================================================================
## Dynamic simulation
## =============================================================================
out &lt;- ode(init, times, chemostat, parms)
plot(out)

## =============================================================================
## Steady state solution
## =============================================================================
state &lt;- data.frame(
  D = seq(0, 0.6, length.out = 100),
  X = 0,
  S = 0
)

for (i in 1:nrow(state)) {
  parms["D"] &lt;- state$D[i]
  times &lt;- c(0, Inf)
  out &lt;- runsteady(init, times, chemostat, parms)
  state[i, 2:3] &lt;- out$y
}

par(mfrow = c(3, 1))
```

![](dynamic-intro_files/figure-html/unnamed-chunk-3-1.png)&lt;!-- --&gt;

```r
plot(S ~ D, data = state, type = "l")
plot(X ~ D, data = state, type = "l")
plot(S * X ~ D, data = state, type = "l")
```

![](dynamic-intro_files/figure-html/unnamed-chunk-3-2.png)&lt;!-- --&gt;
]

---

## Interaction Between Populations: Lotka-Volterra's Predator and Prey


* state diagram, cycles
* damped cycle if we introduce a Monod term

---

## Efficient Model Formulation in Matrix Style


* multi-species predator-prey model

---

## PDE's in 1D: Transport in a River


* package ReacTran
* uses also matrix formulation
* plot3D example

---

## Outlook


* some bigger applications
* rodeo package
* shiny

---

## Appendices


Things that should be mentioned somewhere, but not yet in the introductory
lecture

* Solver functions in deSolve
* C and Fortran interface
* Karline's books
* Online resources: R-Forge, CRAN-Taskview, publications



---

## Copyright


This resource was created by [tpetzoldt](github.com/tpetzoldt) and 
[karlines](https://github.com/karlines). It is provided 
as is without warranty.

---

## Bibliography

.scrollable[
&lt;a name=bib-deSolve_jss&gt;&lt;/a&gt;[Soetaert, K., T. Petzoldt, and R. Setzer](#cite-deSolve_jss) (2010b). "Solving
Differential Equations in R: Package 'deSolve'". In: _Journal of Statistical Software_ 33.9, pp. 1-25. ISSN:
1548-7660. URL: [http://www.jstatsoft.org/v33/i09](http://www.jstatsoft.org/v33/i09).
]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="tp_xaringan.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"self_contained": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
